<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bee Escape Game</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-image: url(images/bg.avif);
      background-repeat: no-repeat;
      background-size: cover;
    }
    .enemy {
      width: 50px;
      height: 50px;
      position: absolute;
      pointer-events: none;
    }
    .cursor {
      width: 20px;
      height: 20px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%);
      border-radius: 50%;
      background: transparent;
      pointer-events: none;
      z-index: 111;
      transition: transform 0.1s ease-out; /* Add smooth transition */
    }
    .cursor img {
      height: 50px;
    }
    .item {
      width: 50px;
      height: 50px;
      position: absolute;
      pointer-events: none;
    }
    #startGameOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 999;
    }
    #startGameButton {
      background: #3498db;
      color: #fff;
      padding: 10px 20px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="startGameOverlay">
  <h1>Welcome to the Bee Escape Game</h1>
  <button id="startGameButton">Start Game</button>
</div>
<audio id="bgMusic" src="./sound/bg_score.mp3" autoplay loop></audio>

<div class="cursor">
  <img src="/images/bee.gif" id="img" />
</div>
<div class="item-container"></div>
<p id="score">Score: 0</p>

<script>
  const numEnemies = 4;
  const enemies = [];
  const maxX = window.innerWidth;
  const maxY = window.innerHeight;
  const maxSpeed = 3;
  const aggressionFactor = 2;
  const avoidDistance = 100;
  const trackDistance = 150;
  const avoidForce = 2;
  let score = 0;
  let gameStarted = false;

  const bgMusic = document.getElementById('bgMusic');
  const startGameOverlay = document.getElementById('startGameOverlay');
  const startGameButton = document.getElementById('startGameButton');
  const cursor = document.querySelector('.cursor');
  const scoreDisplay = document.getElementById('score');
  const itemContainer = document.querySelector('.item-container');

  const hitSound = new Audio('./sound/hit.wav');
  const gameOverSound = new Audio('./sound/player-loosing.wav');

  // Cache initial values
  let lastTimestamp = 0;

  // Game Initialization
  startGameButton.addEventListener('click', () => {
    startGameOverlay.style.display = 'none';
    startGame();
    bgMusic.play();
  });

  function startGame() {
    gameStarted = true;
    for (let i = 0; i < numEnemies; i++) {
      createEnemy();
    }
    setInterval(createItem, 3000);
    requestAnimationFrame(gameLoop);
  }

  function createEnemy() {
    const enemy = document.createElement('img');
    enemy.classList.add('enemy');
    enemy.src = 'images/enemy.gif';
    enemy.style.left = `${Math.random() * maxX}px`;
    enemy.style.top = `${Math.random() * maxY}px`;
    enemy.velocityX = (Math.random() - 0.5) * maxSpeed;
    enemy.velocityY = (Math.random() - 0.5) * maxSpeed;
    document.body.appendChild(enemy);
    enemies.push(enemy);
  }

  function createItem() {
    if (!gameStarted) return;
    const item = document.createElement('img');
    item.classList.add('item');
    item.src = 'images/flower.gif';
    item.style.left = `${Math.random() * (maxX - 30)}px`;
    item.style.top = `${Math.random() * (maxY - 30)}px`;
    itemContainer.appendChild(item);
  }

  function moveEnemies() {
    enemies.forEach(enemy => {
      enemy.style.left = (parseFloat(enemy.style.left) + enemy.velocityX + maxX) % maxX + 'px';
      enemy.style.top = (parseFloat(enemy.style.top) + enemy.velocityY + maxY) % maxY + 'px';
    });
  }

  function checkCollisions() {
    const cursorX = cursor.offsetLeft + cursor.clientWidth / 2;
    const cursorY = cursor.offsetTop + cursor.clientHeight / 2;
    const items = document.querySelectorAll('.item');

    items.forEach(item => {
      const itemX = item.offsetLeft + item.clientWidth / 2;
      const itemY = item.offsetTop + item.clientHeight / 2;
      const distance = Math.sqrt(Math.pow(cursorX - itemX, 2) + Math.pow(cursorY - itemY, 2));

      if (distance < 20) {
        item.remove();
        score++;
        hitSound.play();
        updateScore();
      }
    });
  }

  function avoidCollision() {
    enemies.forEach((enemy, i) => {
      for (let j = 0; j < enemies.length; j++) {
        if (i !== j) {
          const dx = enemy.offsetLeft - enemies[j].offsetLeft;
          const dy = enemy.offsetTop - enemies[j].offsetTop;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < avoidDistance) {
            const avoidX = dx / distance * avoidForce;
            const avoidY = dy / distance * avoidForce;
            enemy.velocityX += avoidX;
            enemy.velocityY += avoidY;
          }
        }
      }
    });
  }

  function trackBeeMovement(e) {
    if (!gameStarted) return;
    const mouseX = e.pageX;
    const mouseY = e.pageY;

    // Smoothly move the bee towards the mouse
    const beeX = cursor.offsetLeft + cursor.clientWidth / 2;
    const beeY = cursor.offsetTop + cursor.clientHeight / 2;
    const dx = mouseX - beeX;
    const dy = mouseY - beeY;

    // Apply smoothing with a small step
    const step = 0.1; // Adjust this to control the smoothness of the movement
    cursor.style.left = beeX + dx * step + 'px';
    cursor.style.top = beeY + dy * step + 'px';

    enemies.forEach(enemy => {
      const enemyX = enemy.offsetLeft + enemy.clientWidth / 2;
      const enemyY = enemy.offsetTop + enemy.clientHeight / 2;

      const dx = mouseX - enemyX;
      const dy = mouseY - enemyY;
      const distance = Math.sqrt(dx * dx + dy * dy);

      if (distance < trackDistance) {
        const speed = maxSpeed * aggressionFactor;
        enemy.velocityX = (dx / distance) * speed;
        enemy.velocityY = (dy / distance) * speed;

        if (distance < 20) {
          gameOver();
        }
      }
    });
  }

  function gameOver() {
    bgMusic.pause();
    gameOverSound.play();
    alert('Game Over! Your Score: ' + score);
    gameStarted = false;
    startGameOverlay.style.display = 'block';
    score = 0;
    updateScore();
    clearEnemies();
  }

  function updateScore() {
    scoreDisplay.textContent = `Score: ${score}`;
  }

  function clearEnemies() {
    enemies.forEach(enemy => {
      enemy.remove();
    });
    enemies.length = 0;
  }

  function gameLoop(timestamp) {
    if (!gameStarted) return;

    // Throttle the game loop
    if (timestamp - lastTimestamp < 1000 / 60) { // 60 FPS
      requestAnimationFrame(gameLoop);
      return;
    }

    lastTimestamp = timestamp;

    moveEnemies();
    avoidCollision();
    checkCollisions();

    requestAnimationFrame(gameLoop);
  }

  document.addEventListener('mousemove', e => {
    trackBeeMovement(e);
  });
</script>

</body>
</html>
